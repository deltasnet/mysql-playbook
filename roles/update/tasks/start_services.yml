---
- name: Start Orchestrator service
  become: true
  become_user: root
  ansible.builtin.service:
    name: Orchestrator
    state: started

- name: "Wait for port {{ Orchestrator_restapi_port }} to become open on the host"
  ansible.builtin.wait_for:
    port: '{{ Orchestrator_restapi_port }}'
    host: '{{ hostvars[inventory_hostname][''inventory_hostname''] }}'
    state: started
    timeout: 60
    delay: 10

- name: Check that the Orchestrator is healthy
  ansible.builtin.uri:
    url: http://{{ inventory_hostname }}:{{ Orchestrator_restapi_port }}/health
    status_code: 200
  register: Orchestrator_replica_result
  until: Orchestrator_replica_result.status == 200
  retries: 300
  delay: 2

- name: Check MySQL is started and accepting connections
  become: true
  become_user: postgres
  ansible.builtin.command: "{{ MySQL_bin_dir }}/pg_isready -p {{ MySQL_port }}"
  register: pg_isready_result
  until: pg_isready_result.rc == 0
  retries: 30
  delay: 2
  changed_when: false
...
